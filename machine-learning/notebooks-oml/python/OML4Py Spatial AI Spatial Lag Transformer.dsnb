[{"layout":null,"template":null,"templateConfig":null,"name":"OML4Py Spatial AI Spatial Lag Transformer","description":null,"readOnly":false,"type":"low","paragraphs":[{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":null,"message":["%md","","# Spatial Lag Transformer - Spatial AI in Oracle Machine Learning for Python (OML4Py)","","Oracle Machine Learning for Python (OML4Py) makes the Python environment ready for the enterprise. OML4Py integrates Python with Oracle Autonomous Database, enabling the use of Python for machine learning and visualization from database tables and views. Spatial AI is a feature of OML4Py providing algorithms and APIs to analyze, make predictions, and detect patterns from geospatial data. ","","The spatial lag of a feature reflects the aggregate value of that feature in the neighborhood around each observation, and is used across Spatial AI in prediction and pattern detection models. ","","In this notebook you work with demographic data for [US Census Block Groups](https://en.wikipedia.org/wiki/Census_block_group) in the City of Los Angeles. You will generate spatial lag for age and house value from neighboring areas. ","","**Copyright (c) 2026 Oracle Corporation**","[The Universal Permissive License (UPL), Version 1.0](https://oss.oracle.com/licenses/upl/)"," "],"enabled":true,"result":{"startTime":1737668441469,"interpreter":"md.low","endTime":1737668442159,"results":[{"message":"<h1 id=\"spatial-lag-transformer---spatial-ai-in-oracle-machine-learning-for-python-oml4py\">Spatial Lag Transformer - Spatial AI in Oracle Machine Learning for Python (OML4Py)<\/h1>\n<p>Oracle Machine Learning for Python (OML4Py) makes the Python environment ready for the enterprise. OML4Py integrates Python with Oracle Autonomous Database, enabling the use of Python for machine learning and visualization from database tables and views. Spatial AI is a feature of OML4Py providing algorithms and APIs to analyze, make predictions, and detect patterns from geospatial data.<\/p>\n<p>The spatial lag of a feature reflects the aggregate value of that feature in the neighborhood around each observation, and is used across Spatial AI in prediction and pattern detection models.<\/p>\n<p>In this notebook you work with demographic data for <a href=\"https://en.wikipedia.org/wiki/Census_block_group\">US Census Block Groups<\/a> in the City of Los Angeles. You will generate spatial lag for age and house value from neighboring areas.<\/p>\n<p><strong>Copyright (c) 2026 Oracle Corporation<\/strong>\n<a href=\"https://oss.oracle.com/licenses/upl/\">The Universal Permissive License (UPL), Version 1.0<\/a><\/p>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":false,"hideVizConfig":true,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":"Before you begin","message":["%md","","Run the notebook **OML4Py Spatial AI Run-me-first** which loads data used in all sample notebooks."," "],"enabled":true,"result":{"startTime":1737668442779,"interpreter":"md.low","endTime":1737668443317,"results":[{"message":"<p>Run the notebook <strong>OML4Py Spatial AI Run-me-first<\/strong> which loads data used in all sample notebooks.<\/p>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":0,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":true,"hideVizConfig":true,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":"Import required libraries","message":["%python","","import os","import geopandas","from sklearn.preprocessing import RobustScaler","from sklearn.impute import SimpleImputer","from libpysal import weights","import matplotlib.pyplot as plt","import pandas as pd","import numpy as np","","import random","random_state = 456","random.seed(random_state)","","from oraclesai import SpatialDataFrame, DBSpatialDataset","from oraclesai.pipeline import SpatialPipeline, SpatialFeatureUnion, SpatialColumnTransformer","from oraclesai.preprocessing import SpatialLagTransformer","from oraclesai.weights import SpatialWeights, KNNWeightsDefinition, DistanceBandWeightsDefinition, QueenWeightsDefinition, RookWeightsDefinition","from oraclesai import enable_geodataframes","enable_geodataframes(z)"],"enabled":true,"result":{"startTime":1737668443826,"interpreter":"python.low","endTime":1737668447399,"results":[],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":false,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":true,"hideVizConfig":false,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"table","title":"Create SpatialDataFrame for LA_BLOCK_GROUPS table","message":["%python","","block_groups_sdf = SpatialDataFrame.create(DBSpatialDataset(table='la_block_groups'))","block_groups_sdf = block_groups_sdf[['GEOID','MEDIAN_INCOME', 'MEAN_AGE', 'HOUSE_VALUE', 'geometry']]","# convert to projected coordinate system as required by spatial weights","block_groups_sdf = block_groups_sdf.to_crs(\"epsg:3857\")","z.show(block_groups_sdf.head())"],"enabled":true,"result":{"startTime":1737668447933,"interpreter":"python.low","endTime":1737668448593,"results":[{"message":"GEOID\tMEDIAN_INCOME\tMEAN_AGE\tHOUSE_VALUE\tgeometry\n060376700031\t75577\t37.306\t627700\tPOLYGON ((-13171614.921 4002458.952, -13171006.56 4002139.446, -13171013.684 4001739.038, -13171618.149 4001743.458, -13171614.921 4002458.952))\n060376700032\t74609\t39.161\t599300\tPOLYGON ((-13171618.149 4001743.458, -13171013.684 4001739.038, -13171015.02 4000576.34, -13171318.477 4000575.938, -13171317.364 4000963.044, -13171619.596 4000964.384, -13171618.149 4001743.458))\n060376700033\t55592\t47.854\t609500\tPOLYGON ((-13172221.723 4001742.521, -13171917.599 4001742.655, -13171921.495 4000965.188, -13171619.596 4000964.384, -13171317.364 4000963.044, -13171318.477 4000575.938, -13171620.932 4000577.813, -13172015.56 4000578.081, -13172039.716 4000577.947, -13172233.857 4000679.478, -13172221.723 4001742.521))\n060376700034\t73558\t39.283\t471000\tPOLYGON ((-13172222.837 4002094.032, -13171984.724 4002093.229, -13171983.722 4002423.986, -13172204.246 4002425.058, -13172206.918 4002769.356, -13171614.921 4002458.952, -13171618.149 4001743.458, -13171619.596 4000964.384, -13171921.495 4000965.188, -13171917.599 4001742.655, -13172221.723 4001742.521, -13172222.837 4002094.032))\n060376701001\t54738\t37.998\t389900\tPOLYGON ((-13171620.932 4000577.813, -13171318.477 4000575.938, -13171015.02 4000576.34, -13170712.342 4000574.063, -13170717.463 4000012.581, -13171091.051 4000012.313, -13171186.007 3999904.092, -13171571.395 4000085.443, -13171620.932 3999984.052, -13171620.932 4000577.813))\n","type":"TABLE"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":false,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":true,"hideVizConfig":false,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":null,"message":["%md","","Next you create a SpatialLagTransformer. The neighbors to use for calculating spatial lag is based on a spatial weights definition. In this case you use the 5 nearest neighbors. "],"enabled":true,"result":{"startTime":1737668449219,"interpreter":"md.low","endTime":1737668449751,"results":[{"message":"<p>Next you create a SpatialLagTransformer. The neighbors to use for calculating spatial lag is based on a spatial weights definition. In this case you use the 5 nearest neighbors.<\/p>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":false,"hideVizConfig":true,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":"Create a SpatialLagTransformer","message":["%python","","spatial_lag_transformer = SpatialLagTransformer(spatial_weights_definition= KNNWeightsDefinition(k=5)) "],"enabled":true,"result":{"startTime":1737668450280,"interpreter":"python.low","endTime":1737668450783,"results":[],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":false,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":true,"hideVizConfig":false,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":null,"message":["%md","","You will use the SpatialLagTransformer to transform the original data and incorporate the spatial lag of `mean_age` and `house_value` as new features. "],"enabled":true,"result":{"startTime":1737668451314,"interpreter":"md.low","endTime":1737668451809,"results":[{"message":"<p>You will use the SpatialLagTransformer to transform the original data and incorporate the spatial lag of <code>mean_age<\/code> and <code>house_value<\/code> as new features.<\/p>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":false,"hideVizConfig":true,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"table","title":"Apply the SpatialLagTransformer","message":["%python","","block_groups_lag = spatial_lag_transformer.fit_transform(block_groups_sdf.drop(\"GEOID\"), y=\"MEDIAN_INCOME\")","df = pd.DataFrame(block_groups_lag, columns=['mean_age_lag', 'house_value_lag'])","df.insert(0, 'GEOID', block_groups_sdf[[\"GEOID\"]].get_values().flatten())","z.show(df.head())"],"enabled":true,"result":{"startTime":1737668452373,"interpreter":"python.low","endTime":1737668467627,"results":[{"message":"GEOID\tmean_age_lag\thouse_value_lag\n060376700031\t39.959478064337624\t552980.0\n060376700032\t40.11939191015061\t536360.0\n060376700033\t42.53606992859642\t452720.0\n060376700034\t41.12949758172174\t616220.0\n060376701001\t41.989081664093014\t602700.0\n","type":"TABLE"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":false,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":true,"hideVizConfig":false,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":null,"message":["%md","","","SpatialFeatureUnion is a type of spatial pipeline that returns results for each step. Next you use SpatialLagTransformer with SpatialFeatureUnion to generate lag features for different spatial weights definitions. "],"enabled":true,"result":{"startTime":1737668468136,"interpreter":"md.low","endTime":1737668468639,"results":[{"message":"<p>SpatialFeatureUnion is a type of spatial pipeline that returns results for each step. Next you use SpatialLagTransformer with SpatialFeatureUnion to generate lag features for different spatial weights definitions.<\/p>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":false,"hideVizConfig":true,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"table","title":"Use SpatialLagTransformer with SpatialFeatureUnion","message":["%python","","spatial_feature_union = SpatialFeatureUnion([(\"spatial_lag_knn5\", SpatialLagTransformer(spatial_weights_definition= KNNWeightsDefinition(k=5))) , ","                                           (\"spatial_lag_knn10\",SpatialLagTransformer(spatial_weights_definition= KNNWeightsDefinition(k=10)))])","lag_feature_union = spatial_feature_union.fit_transform(block_groups_sdf.drop(\"GEOID\"), y=\"MEDIAN_INCOME\")","df = pd.DataFrame(lag_feature_union, columns=['age_lag_knn5', 'houseval_lag_knn5','age_lag_knn10', 'houseval_lag_knn10' ])","df.insert(0, 'GEOID', block_groups_sdf[[\"GEOID\"]].get_values().flatten())","z.show(df.head())","","                                                            ","","                                "],"enabled":true,"result":{"startTime":1737668469148,"interpreter":"python.low","endTime":1737668484903,"results":[{"message":"GEOID\tage_lag_knn5\thouseval_lag_knn5\tage_lag_knn10\thouseval_lag_knn10\n060376700031\t39.959478064337624\t552980.0\t41.31516929216667\t593620.0\n060376700032\t40.11939191015061\t536360.0\t40.55946442843291\t541160.0\n060376700033\t42.53606992859642\t452720.0\t41.058474969394794\t544580.0\n060376700034\t41.12949758172174\t616220.0\t41.017264960537766\t606690.0\n060376701001\t41.989081664093014\t602700.0\t40.8813156088885\t547440.0\n","type":"TABLE"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":false,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":true,"hideVizConfig":false,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":null,"message":["%md","","","Note that you can also use `SpatialLagTransformer` with `SpatialColumnTransformer`. As with `SpatialFeatureUnion`, the `SpatialColumnTransformer` appends the resulting data of each step in the outcome, with the difference that it does it using specific columns for each step instead of using the whole dataset.","","In summary, adding spatial lags to a dataset provides geographic information. Closer elements tend to be more related than distant elements. Having this geographic information can be used for training spatial models using spatial lag and spatial error algorithms that include spatial dependence in the regression equation.","","Adding the spatial lags as features can be done in different ways, either by using the `SpatialLagTransfomer` directly or by using methods that append these features like the `SpatialFeatureUnion` and the `SpatialColumnTransformer`."],"enabled":true,"result":{"startTime":1737668485441,"interpreter":"md.low","endTime":1737668485978,"results":[{"message":"<p>Note that you can also use <code>SpatialLagTransformer<\/code> with <code>SpatialColumnTransformer<\/code>. As with <code>SpatialFeatureUnion<\/code>, the <code>SpatialColumnTransformer<\/code> appends the resulting data of each step in the outcome, with the difference that it does it using specific columns for each step instead of using the whole dataset.<\/p>\n<p>In summary, adding spatial lags to a dataset provides geographic information. Closer elements tend to be more related than distant elements. Having this geographic information can be used for training spatial models using spatial lag and spatial error algorithms that include spatial dependence in the regression equation.<\/p>\n<p>Adding the spatial lags as features can be done in different ways, either by using the <code>SpatialLagTransfomer<\/code> directly or by using methods that append these features like the <code>SpatialFeatureUnion<\/code> and the <code>SpatialColumnTransformer<\/code>.<\/p>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":12,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":false,"hideVizConfig":true,"hideGutter":true,"relations":[],"forms":"[]"},{"col":0,"visualizationConfig":null,"hideInIFrame":false,"selectedVisualization":"html","title":null,"message":["%md","","## End of Script "],"enabled":true,"result":{"startTime":1737668486548,"interpreter":"md.low","endTime":1737668487079,"results":[{"message":"<h2 id=\"end-of-script\">End of Script<\/h2>\n","type":"HTML"}],"taskStatus":"SUCCESS","forms":"[]","status":"SUCCESS"},"sizeX":0,"hideCode":true,"width":0,"hideResult":false,"dynamicFormParams":"{}","row":0,"hasTitle":false,"hideVizConfig":false,"hideGutter":true,"relations":[],"forms":"[]"}],"version":"6","snapshot":false,"tags":null}]